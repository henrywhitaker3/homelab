kind: pipeline
type: docker
name: docker playbook

steps:
- name: docker playbook
  image: henrywhitaker3/ansible-terraform
  when:
    branch:
      - main
  environment:
    SSH_KEY:
      from_secret: HOMELAB_SSH_KEY
    VAULT_PASS:
      from_secret: ANSIBLE_VAULT_PASS
  commands:
    - task drone-vault-pass
    # - task drone-ssh-up
    - eval $(ssh-agent -s)
    - task drone-ssh-keyscan 10.0.0.160
    - task drone-playbook docker/main.yaml

---
kind: pipeline
type: docker
name: k8s playbook

steps:
- name: k8s playbook
  image: henrywhitaker3/ansible-terraform
  when:
    branch:
      - main
  environment:
    SSH_KEY:
      from_secret: HOMELAB_SSH_KEY
    VAULT_PASS:
      from_secret: ANSIBLE_VAULT_PASS
  commands:
    - task drone-vault-pass
    - task drone-ssh-up
    - task drone-ssh-keyscan 10.0.0.20
    - task drone-ssh-keyscan 10.0.0.21
    - task drone-ssh-keyscan 10.0.0.22
    - task drone-playbook k8s/main.yaml

---

kind: pipeline
type: docker
name: pihole playbook

steps:
- name: pihole playbook
  image: henrywhitaker3/ansible-terraform
  when:
    branch:
      - main
  environment:
    SSH_KEY:
      from_secret: HOMELAB_SSH_KEY
    VAULT_PASS:
      from_secret: ANSIBLE_VAULT_PASS
  commands:
    - task drone-vault-pass
    - task drone-ssh-up
    - task drone-ssh-keyscan 10.0.0.2
    - task drone-playbook pihole/main.yaml
