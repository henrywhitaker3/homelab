kind: pipeline
type: docker
name: docker playbook

steps:
- name: docker playbook
  image: henrywhitaker3/ansible-terraform
  when:
    branch:
      - main
  environment:
    SSH_KEY:
      from_secret: HOMELAB_SSH_KEY
    SSH_PUBKEY:
      from_secret: HOMELAB_SSH_PUBKEY
    KNOWN_HOSTS:
      from_secret: HOMELAB_KNOWN_HOSTS
    VAULT_PASS:
      from_secret: ANSIBLE_VAULT_PASS
  commands:
    - echo $VAULT_PASS > ~/.vault_pass.txt

    - eval $(ssh-agent -s)
    - echo "$SSH_KEY" | tr -d '\r' | ssh-add -
    - echo -e $KNOWN_HOSTS > ~/.ssh/known_hosts

    - ansible-playbook --vault-password-file ~/.vault_pass.txt docker/main.yaml
---
kind: pipeline
type: docker
name: k8s playbook

steps:
- name: k8s playbook
  image: henrywhitaker3/ansible-terraform
  when:
    branch:
      - main
  environment:
    SSH_KEY:
      from_secret: HOMELAB_SSH_KEY
    SSH_PUBKEY:
      from_secret: HOMELAB_SSH_PUBKEY
    KNOWN_HOSTS:
      from_secret: HOMELAB_KNOWN_HOSTS
    VAULT_PASS:
      from_secret: ANSIBLE_VAULT_PASS
  commands:
    - echo $VAULT_PASS > ~/.vault_pass.txt

    - eval $(ssh-agent -s)
    - echo "$SSH_KEY" | tr -d '\r' | ssh-add -
    - echo -e $KNOWN_HOSTS > ~/.ssh/known_hosts

    - ansible-playbook --vault-password-file ~/.vault_pass.txt k8s/main.yaml
---
kind: pipeline
type: docker
name: pihole playbook

steps:
- name: pihole playbook
  image: henrywhitaker3/ansible-terraform
  when:
    branch:
      - main
  environment:
    SSH_KEY:
      from_secret: HOMELAB_SSH_KEY
    SSH_PUBKEY:
      from_secret: HOMELAB_SSH_PUBKEY
    KNOWN_HOSTS:
      from_secret: HOMELAB_KNOWN_HOSTS
    VAULT_PASS:
      from_secret: ANSIBLE_VAULT_PASS
  commands:
    - echo $VAULT_PASS > ~/.vault_pass.txt

    - eval $(ssh-agent -s)
    - echo "$SSH_KEY" | tr -d '\r' | ssh-add -
    - echo -e $KNOWN_HOSTS > ~/.ssh/known_hosts

    - ansible-playbook --vault-password-file ~/.vault_pass.txt pihole/main.yaml
