kind: pipeline
type: docker
name: docker playbook

steps:
- name: Setup vault password
  image: henrywhitaker3/ansible-terraform
  when:
    branch:
      - main
  environment:
    SSH_KEY:
      from_secret: HOMELAB_SSH_KEY
    VAULT_PASS:
      from_secret: ANSIBLE_VAULT_PASS
  commands:
    - echo $VAULT_PASS > ~/.vault_pass.txt
    - export ANSIBLE_VAULT_PASSWORD_FILE=~/.vault_pass.txt
  volumes:
    - name: ssh
      path: /home/abc/.ssh

- name: Setup SSH
  image: henrywhitaker3/ansible-terraform
  when:
    branch:
      - main
  environment:
    SSH_KEY:
      from_secret: HOMELAB_SSH_KEY
    VAULT_PASS:
      from_secret: ANSIBLE_VAULT_PASS
  commands:
    - eval $(ssh-agent -s)
    - echo "$SSH_KEY" | tr -d '\r' | ssh-add -
    - ssh-keyscan -H 10.0.0.160 >> ~/.ssh/known_hosts

- name: Run playbook
  image: henrywhitaker3/ansible-terraform
  when:
    branch:
      - main
  environment:
    SSH_KEY:
      from_secret: HOMELAB_SSH_KEY
    VAULT_PASS:
      from_secret: ANSIBLE_VAULT_PASS
  commands:
    - ansible-playbook --vault-password-file ~/.vault_pass.txt docker/main.yaml
  volumes:
    - name: ssh
      path: /home/abc/.ssh

volumes:
- name: ssh
  temp: {}

---
kind: pipeline
type: docker
name: k8s playbook

steps:
- name: k8s playbook
  image: henrywhitaker3/ansible-terraform
  when:
    branch:
      - main
  environment:
    SSH_KEY:
      from_secret: HOMELAB_SSH_KEY
    VAULT_PASS:
      from_secret: ANSIBLE_VAULT_PASS
  commands:
    - echo $VAULT_PASS > ~/.vault_pass.txt

    - eval $(ssh-agent -s)
    - echo "$SSH_KEY" | tr -d '\r' | ssh-add -
    - ssh-keyscan -H 10.0.0.20 >> ~/.ssh/known_hosts
    - ssh-keyscan -H 10.0.0.21 >> ~/.ssh/known_hosts
    - ssh-keyscan -H 10.0.0.22 >> ~/.ssh/known_hosts

    - ansible-playbook --vault-password-file ~/.vault_pass.txt k8s/main.yaml
---
kind: pipeline
type: docker
name: pihole playbook

steps:
- name: pihole playbook
  image: henrywhitaker3/ansible-terraform
  when:
    branch:
      - main
  environment:
    SSH_KEY:
      from_secret: HOMELAB_SSH_KEY
    VAULT_PASS:
      from_secret: ANSIBLE_VAULT_PASS
  commands:
    - echo $VAULT_PASS > ~/.vault_pass.txt

    - eval $(ssh-agent -s)
    - echo "$SSH_KEY" | tr -d '\r' | ssh-add -
    - ssh-keyscan -H 10.0.0.2 >> ~/.ssh/known_hosts

    - ansible-playbook --vault-password-file ~/.vault_pass.txt pihole/main.yaml
