---
# yaml-language-server: $schema=https://github.com/datreeio/CRDs-catalog/raw/refs/heads/main/gateway.networking.k8s.io/referencegrant_v1beta1.json
apiVersion: gateway.networking.k8s.io/v1beta1
kind: ReferenceGrant
metadata:
  name: authelia
  namespace: authelia
spec:
  from:
    - group: gateway.networking.k8s.io
      kind: Gateway
      namespace: gateways
  to:
    - group: ""
      kind: Service
      name: authelia
---
# yaml-language-server: $schema=https://github.com/datreeio/CRDs-catalog/raw/refs/heads/main/gateway.networking.k8s.io/referencegrant_v1beta1.json
apiVersion: gateway.networking.k8s.io/v1beta1
kind: ReferenceGrant
metadata:
  name: organizr
  namespace: media
spec:
  from:
    - group: gateway.networking.k8s.io
      kind: Gateway
      namespace: gateways
  to:
    - group: ""
      kind: Service
      name: organizr
{{- range .Values.middlewares.authelia.namespaces }}
---
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayPolicy
metadata:
  name: authelia
  namespace: "{{ .name }}"
spec:
  # targetSelectors:
  #   - group: gateway.networking.k8s.io
  #     kind: HTTPRoute
  #     matchLabels:
  #       auth: authelia
  targetRefs:
    {{- range .http }}
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: "{{ . }}"
    {{- end }}
  traffic:
    extAuth:
      backendRef:
        name: authelia
        namespace: authelia
        port: 80
      http:
        path: "'/api/authz/forward-auth'"
        redirect: has(response.headers.location) && response.headers.location
        addRequestHeaders:
          X-Forwarded-Method: request.method
          X-Forwarded-Proto: request.scheme
          X-Forwarded-Host: request.host
          X-Forwarded-URI: request.path
          X-Forwarded-For: source.address
        allowedRequestHeaders:
          - "accept"
          - "cookie"
          - "authorization"
          - "proxy-authorization"
        allowedResponseHeaders:
          - "location"
          - "Remote-User"
          - "Remote-Groups"
          - "Remote-Email"
          - "Remote-Name"
{{- end }}
{{- range .Values.middlewares.organizr.namespaces }}
---
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayPolicy
metadata:
  name: organizr
  namespace: "{{ .name }}"
spec:
  targetRefs:
    {{- range .http }}
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: "{{ . }}"
    {{- end }}
  traffic:
    extAuth:
      backendRef:
        name: organizr
        namespace: media
        port: 80
      http:
        path: "'/api/v2/auth?group=1'"
        redirect: "'https://plexmox.com'"
{{- end }}
