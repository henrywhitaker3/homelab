tempo:
  replicas: 1

  service:
    type: LoadBalancer
    annotations:
     metallb.universe.tf/loadBalancerIPs: 10.0.0.37

  tempo:
    repository: grafana/tempo
    tag: 2.4.1

    retention: 24h
    storage:
      trace:
        backend: s3
        s3:
          bucket: tempo
          endpoint: s3.plexmox.com
          region: unraid
          insecure: false
          access_key: ${MINIO_ACCESS_KEY}
          secret_key: ${MINIO_SECRET_KEY}
          forcepathstyle: true

    metricsGenerator:
      enabled: true
      remoteWriteUrls:
        - http://prometheus-kube-stack-prometheus-0:9090/api/v1/write
        - http://prometheus-kube-stack-prometheus-1:9090/api/v1/write

    overrides:
      defaults:
        metrics_generator:
          processors: ['local-blocks']

    extraArgs:
      config.expand-env: true
    extraEnv:
      - name: MINIO_ACCESS_KEY
        valueFrom:
          secretKeyRef:
            name: tempo-minio
            key: aws-access-key-id
      - name: MINIO_SECRET_KEY
        valueFrom:
          secretKeyRef:
            name: tempo-minio
            key: aws-secret-access-key

  config: |
    multitenancy_enabled: {{ .Values.tempo.multitenancyEnabled }}
    usage_report:
      reporting_enabled: {{ .Values.tempo.reportingEnabled }}
    compactor:
      compaction:
        block_retention: {{ .Values.tempo.retention }}
    distributor:
      receivers:
        {{- toYaml .Values.tempo.receivers | nindent 8 }}
    ingester:
      {{- toYaml .Values.tempo.ingester | nindent 6 }}
    server:
      {{- toYaml .Values.tempo.server | nindent 6 }}
    storage:
      {{- toYaml .Values.tempo.storage | nindent 6 }}
    querier:
      {{- toYaml .Values.tempo.querier | nindent 6 }}
    query_frontend:
      {{- toYaml .Values.tempo.queryFrontend | nindent 6 }}
    overrides:
      {{- toYaml .Values.tempo.global_overrides | nindent 6 }}
      {{- if .Values.tempo.metricsGenerator.enabled }}
          metrics_generator_processors:
          - 'service-graphs'
          - 'span-metrics'
          - 'local-blocks'
    metrics_generator:
          storage:
            path: "/tmp/tempo"
            remote_write:
            {{- range $url := .Values.tempo.metricsGenerator.remoteWriteUrls }}
              - url: {{ . }}
            {{- end }}
      {{- end }}
