---
- name: Generate hosts list
  tags: hosts
  ansible.builtin.set_fact:
    hosts_render: "{{ lookup('template', 'templates/hosts') }}"

- name: Check if cloud-init templates exist
  tags: hosts
  become: "{{ hosts_become }}"
  ansible.builtin.stat:
    path: /etc/cloud/templates/hosts.debian.tmpl
  register: hosts_cloud_init

- name: Add list to /etc/hosts
  tags: hosts
  become: "{{ hosts_become }}"
  ansible.builtin.blockinfile:
    path: "/etc/hosts"
    block: "{{ hosts_render }}"
  register: hosts_updated_file

- name: Add list to cloud-init hosts
  tags: hosts
  become: "{{ hosts_become }}"
  ansible.builtin.blockinfile:
    path: /etc/cloud/templates/hosts.debian.tmpl
    block: "{{ hosts_render }}"
  register: cloud_init_hosts_updated_file
  when: hosts_cloud_init.stat.exists
