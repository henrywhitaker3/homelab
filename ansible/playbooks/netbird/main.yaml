---
- name: Configure jump server

  hosts: netbird

  roles:
    - hosts
    - user
    - common
    # - crog
    - node_exporter
    - process_exporter
    - alloy
    - docker

  handlers:
    - name: docker compose up
      become: true
      ansible.builtin.shell: "cd /home/{{ ansible_user }} && docker compose -f docker-compose.yaml up -d --remove-orphans"
      changed_when: true

  tasks:
    # TODO: zitadel provisioning

    - name: Copy over docker compose file
      tags: netbird
      become: true
      ansible.builtin.template:
        src: files/docker-compose.yaml
        dest: "/home/{{ ansible_user }}/docker-compose.yaml"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0644"
      notify: docker compose up
