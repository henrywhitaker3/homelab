---
- name: Configure k8s admin server

  hosts: k8s-control-1.lab

  tasks:
    - name: Copy kubeconfig over locally
      become: true
      ansible.builtin.fetch:
        src: "/home/{{ ansible_user }}/.kube/config"
        dest: /tmp/kubeconfig
        flat: true

    - name: Run bootstrap actions locally
      delegate_to: localhost
      block:
        - name: Set repo base dir
          ansible.builtin.set_fact:
            repo_base_dir: "{{ playbook_dir }}/../../../"

        - name: Bootstrap secrets
          ansible.builtin.command:
            cmd: task argo:bootstrap
            chdir: "{{ repo_base_dir }}"
          environment:
            KUBECONFIG: /tmp/kubeconfig
          register: bs_secrets
          changed_when: "'configured' in bs_secrets.stdout"

        - name: Install argocd
          ansible.builtin.command:
            cmd: task argo:install
            chdir: "{{ repo_base_dir }}"
          environment:
            KUBECONFIG: /tmp/kubeconfig
          changed_when: true

        - name: Install root
          ansible.builtin.command:
            cmd: task argo:root
            chdir: "{{ repo_base_dir }}"
          environment:
            KUBECONFIG: /tmp/kubeconfig
          changed_when: true

        - name: Remove local kubeconfig
          ansible.builtin.file:
            path: /tmp/kubeconfig
            state: absent
