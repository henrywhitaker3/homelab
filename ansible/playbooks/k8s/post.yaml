---
- name: Configure k8s admin server

  hosts: k8s-control-1.lab

  roles:
    - k8s_tools

  tasks:
    - name: Copy argocd over
      tags:
        - k8s
        - argo
      ansible.builtin.copy:
        src: ../../../argo/argocd
        dest: "/home/{{ ansible_user }}/"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0755"

    - name: Copy root over
      tags:
        - k8s
        - argo
      ansible.builtin.copy:
        src: ../../../argo/root
        dest: "/home/{{ ansible_user }}/"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0755"

    - name: Install argocd
      tags:
        - k8s
        - argo
      become: true
      kubernetes.core.helm:
        release_name: argo
        namespace: argo
        create_namespace: true
        chart_ref: "/home/{{ ansible_user }}/argocd"
        values_files:
          - "/home/{{ ansible_user }}/argocd/values.yaml"
        kubeconfig: /etc/rancher/k3s/k3s.yaml
        dependency_update: true
        wait: true

    - name: Get argo root files
      ansible.builtin.find:
        paths: "/home/{{ ansible_user }}/root"
      register: argo_root_files

    - name: Install argo root
      tags:
        - k8s
        - argo
      become: true
      kubernetes.core.k8s:
        src: "{{ item.path }}"
        state: present
        apply: true
        kubeconfig: /etc/rancher/k3s/k3s.yaml
      with_items: "{{ argo_root_files.files }}"
      loop_control:
        label: "{{ item.path }}"

    - name: Create standalone directory
      tags:
        - k8s
        - standalone
      ansible.builtin.file:
        path: "/home/{{ ansible_user }}/standalone"
        state: directory
        mode: "0755"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: Template over standalone manifests
      tags:
        - k8s
        - standalone
      ansible.builtin.template:
        src: "{{ item }}"
        dest: "/home/{{ ansible_user }}/standalone/{{ item | basename }}"
        mode: "0664"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
      with_fileglob:
        - standalone/*

    - name: Install standalone manifests
      tags:
        - k8s
        - standalone
      become: true
      kubernetes.core.k8s:
        src: "/home/{{ ansible_user }}/standalone/{{ item | basename }}"
        state: present
        apply: true
        kubeconfig: /etc/rancher/k3s/k3s.yaml
      with_fileglob:
        - standalone/*
      loop_control:
        label: "{{ item | basename }}"
