apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: srep
spec:
  groups:
    - name: ui
      rules:
        - alert: UIErrorRate
          expr: |
            (
              (
                ( sum( rate(srep_ui_requests_total_count{status=~"2..|3..|4.."}[1m]) or vector(0) ) )
                  /
                ( sum( rate(srep_ui_requests_total_count[1m]) or vector(0) ) )
              ) * 100
            ) < 99.99
          for: 1m
          labels:
            severity: critical
            autoresolve: "false"
          annotations:
            summary: UI Success Rate is < 99.99%
    - name: api
      rules:
        - alert: APIErrorRate
          expr: |
            (
              (
                ( sum( rate(srep_requests_total{code=~"2..|3..|4.."}[1m]) or vector(0) ) )
                  /
                ( sum( rate(srep_requests_total[1m]) or vector(0) ) )
              ) * 100
            ) < 99.99
          for: 1m
          labels:
            severity: critical
            autoresolve: "false"
          annotations:
            summary: API Success Rate is < 99.99%
        - alert: APIErrorLogs
          expr: |
            sum by (msg) (srep_api_error_log_count or vector(0)) > 5
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: More than 5 {{ $labels.msg }} errors seen in last 5 minutes
        - alert: APIMysqlDown
          expr: mysql_up{service="srep-mysql"} == 0
          for: 0m
          labels:
            severity: critical
          annotations:
            summary: API MySQL is down
        - alert: APIMysqlHighThreadsRunning
          expr: max_over_time(mysql_global_status_threads_running{service="srep-mysql"}[1m]) / mysql_global_variables_max_connections{service="srep-mysql"} * 100 > 75
          for: 2m
          labels:
            severity: warning
          annotations:
            summary: MySQL high threads running (instance {{ $labels.instance }})
        - alert: APIRedisDown
          expr: redis_up{service="srep-redis"} == 0
          for: 0m
          labels:
            severity: critical
          annotations:
            summary: Redis down (instance {{ $labels.instance }})
