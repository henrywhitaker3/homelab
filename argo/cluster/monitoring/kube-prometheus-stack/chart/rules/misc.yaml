apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: misc
spec:
  groups:
    - name: vms
      rules:
        - alert: VMDown
          expr: 100 * (count by (instance) (up{job="node_exporter"} == 0) / count by (instance) (up{job="node_exporter"})) > 10
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: Target {{ $labels.instance }} is DOWN
    - name: k8s
      rules:
        - alert: OOMKilled
          expr: (kube_pod_container_status_restarts_total - kube_pod_container_status_restarts_total offset 10m >= 1) and ignoring (reason) min_over_time(kube_pod_container_status_last_terminated_reason{reason="OOMKilled"}[10m]) == 1
          labels:
            severity: critical
          annotations:
            summary: Container {{ $labels.container }} in pod {{ $labels.namespace }}/{{ $labels.pod }} has been OOMKilled {{ $value }} times in the last 10 minutes.
    - name: haproxy
      rules:
        - alert: HaproxyServerNotUp
          expr: haproxy_server_status{state!="UP"} > 0
          for: 3m
          labels:
            severity: critical
          annotations:
            summary: Haproxy Server {{ $labels.server }} is not UP for backend {{ $labels.proxy }}
    - name: argo
      rules:
        - alert: ArgocdServiceUnhealthy
          expr: argocd_app_info{health_status!="Healthy"} != 0
          for: 15m
          labels:
            severity: warning
          annotations:
            summary: ArgoCD service unhealthy (instance {{ $labels.instance }})
        - alert: ArgocdServiceNotSynced
          expr: argocd_app_info{sync_status!="Synced"} != 0
          for: 15m
          labels:
            severity: warning
          annotations:
            summary: ArgoCD service not synced (instance {{ $labels.instance }})
    - name: db
      rules:
        - alert: MysqlDown
          expr: mysql_up{service!~"srep.*"} == 0
          for: 0m
          labels:
            severity: critical
          annotations:
            summary: MySQL down (instance {{ $labels.instance }})
        - alert: MysqlHighThreadsRunning
          expr: max_over_time(mysql_global_status_threads_running{service!~"srep.*"}[1m]) / mysql_global_variables_max_connections{service!~"srep.*"} * 100 > 75
          for: 2m
          labels:
            severity: warning
          annotations:
            summary: MySQL high threads running (instance {{ $labels.instance }})
        - alert: RedisDown
          expr: redis_up{service!~"srep*"} == 0
          for: 0m
          labels:
            severity: critical
          annotations:
            summary: Redis down (instance {{ $labels.instance }})
