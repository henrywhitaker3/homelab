- name: Patch k8s nodes

  hosts: k8s_nodes

  serial: 1

  vars_files:
    - vars/k8s.yaml

  tasks:
    - name: Download k3s binary
      become: true
      ansible.builtin.get_url:
        url: https://github.com/k3s-io/k3s/releases/download/{{ k3s_version }}/k3s
        checksum: sha256:https://github.com/k3s-io/k3s/releases/download/{{ k3s_version }}/sha256sum-amd64.txt
        dest: /usr/local/bin/k3s
        owner: root
        group: root
        mode: "0755"
      register: k3s_binary_dl

    - name: Restart k3s
      become: true
      ansible.builtin.service:
        name: k3s
        state: restarted
      when: k3s_binary_dl.changed
