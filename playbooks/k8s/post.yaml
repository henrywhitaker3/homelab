---
- name: Configure k8s admin server

  hosts: k8s-control-1.lab

  roles:
    - k8s_tools

  tasks:
    - name: Clone argo
      tags:
        - k8s
        - argo
      ansible.builtin.git:
        repo: https://gitlab.com/henrywhitaker3/argo.git
        dest: "/home/{{ ansible_user }}/argo"
        version: HEAD
      register: argo_clone

    - name: Create argo namespace
      tags:
        - k8s
        - argo
      become: true
      ansible.builtin.command: "kubectl create namespace argo"
      register: argo_namespace_created
      changed_when: "'created' in argo_namespace_created.stdout"
      failed_when: false

    - name: Install argocd
      tags:
        - k8s
        - argo
      become: true
      kubernetes.core.helm:
        release_name: argo
        namespace: argo
        create_namespace: true
        chart_ref: "/home/{{ ansible_user }}/argo/argocd"
        values_files:
          - "/home/{{ ansible_user }}/argo/argocd/values.yaml"
        kubeconfig: /etc/rancher/k3s/k3s.yaml
        dependency_update: true
        wait: true

    - name: Get argo root files
      ansible.builtin.find:
        paths: "/home/{{ ansible_user }}/argo/root"
      register: argo_root_files

    - name: Install argo root
      tags:
        - k8s
        - argo
      become: true
      kubernetes.core.k8s:
        src: "{{ item.path }}"
        state: present
        kubeconfig: /etc/rancher/k3s/k3s.yaml
      with_items: "{{ argo_root_files.files }}"
      loop_control:
        label: "{{ item.path }}"

    - name: Create standalone directory
      tags:
        - k8s
        - standalone
      ansible.builtin.file:
        path: "/home/{{ ansible_user }}/standalone"
        state: directory
        mode: "0755"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: Template over standalone manifests
      tags:
        - k8s
        - standalone
      ansible.builtin.template:
        src: "{{ item }}"
        dest: "/home/{{ ansible_user }}/standalone/{{ item | basename }}"
        mode: "0664"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
      with_fileglob:
        - standalone/*

    - name: Install standalone manifests
      tags:
        - k8s
        - standalone
      become: true
      kubernetes.core.k8s:
        src: "/home/{{ ansible_user }}/standalone/{{ item | basename }}"
        state: present
        kubeconfig: /etc/rancher/k3s/k3s.yaml
      with_fileglob:
        - standalone/*
      loop_control:
        label: "{{ item | basename }}"
