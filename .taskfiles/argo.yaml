version: "3"

tasks:
  bootstrap:
    desc: Bootsrap the cluster
    cmds:
      - ./scripts/bootstrap_secrets.sh
      - task: install
      - task: root

  install:
    desc: Install argocd into the cluster
    deps: [repo]
    cmds:
      - helm dependency build argo/argocd
      - helm upgrade --install --create-namespace --wait -n argo -f argo/argocd/values.yaml argo argo/argocd/

  repo:
    cmds:
      - helm repo add argo https://argoproj.github.io/argo-helm

  root:
    desc: Apply the initial manifests
    cmds:
      - kubectl apply -f argo/bootstrap/manifests

  values:
    cmds:
      - helm -n argo get values argo

  apps:
    desc: List argo apps
    cmds:
      - kubectl -n argo get applications

  go:
    desc: Bootstrap the entire cluster, install argo, install manifests
    cmds:
      - task: bootstrap
      - task: install
      - task: root

  login:
    cmds:
      - argocd login $ARGO_CD_IP --insecure --username $ARGO_CD_USER --password $ARGO_CD_PASSWORD

  diff:
    desc: Run a diff on the argo app
    deps: [login]
    requires:
      vars:
        - APP
        - DIR
    env:
      APP: '{{ .APP }}'
      DIR: '{{ .DIR }}'
    preconditions:
      - sh: "[[ ! -z $APP ]]"
        msg: |
          Must set $APP variable
      - sh: "[[ ! -z $DIR ]]"
        msg: |
          Must set $DIR variable
    cmds:
      - argocd app diff $APP --local $DIR --loglevel error

  refresh:
    desc: Trigger a refresh on an app
    cmds:
      - kubectl config set-context --current --namespace=argo
      - argocd app get {{ .CLI_ARGS }} --refresh --core
      - kubectl config set-context --current --namespace=default
