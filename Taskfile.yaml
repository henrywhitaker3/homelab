version: '3'

tasks:
  drone-ssh-key:
    cmds:
      - echo "{{ .SSH_KEY }}" | base64 -d | ssh-add -
    silent: true

  drone-ssh-keyscan:
    cmds:
      - ssh-keyscan -H {{ .TARGET_IPS }} >> ~/.ssh/known_hosts
    silent: true

  drone-vault-pass:
    cmds:
      - echo {{ .VAULT_PASS }} > ~/.vault_pass.txt
    silent: true

  drone-playbook:
    deps: [drone-ssh-key, drone-ssh-keyscan, drone-vault-pass]
    cmds:
      - ansible-playbook --vault-password-file ~/.vault_pass.txt {{ .PLAYBOOK }}

  lint:
    cmds:
      - ansible-lint {{ .PLAYBOOK }} -x 403 -x name[casing] -x yaml[line-length] -x yaml[truthy] -x no-handler

  lint:debug:
    cmds:
      - docker run --rm -v $(pwd):/drone/src -it henrywhitaker3/ansible-terraform bash
