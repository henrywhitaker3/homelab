version: '3'

dotenv: [.env]

includes:
  ansible: .taskfiles/ansible.yaml
  ci: .taskfiles/CI.yaml
  argo: .taskfiles/argo.yaml
  k3s: .taskfiles/k3s.yaml
  tf: .taskfiles/terraform.yaml
  new: .taskfiles/new.yaml
  db: .taskfiles/db.yaml

tasks:
  patch:
    vars:
      PLAYBOOK: '{{ .PLAYBOOK | default "generic" }}'
    cmds:
      - ansible-playbook ansible/playbooks/patch/{{ .PLAYBOOK }}.yaml {{ .CLI_ARGS | default "" }}

  renovate:
    cmds:
      - |
        docker run --rm -v $(pwd):/usr/src/app \
          -e RENOVATE_CONFIG_FILE=/usr/src/app/renovate.json \
          -e RENOVATE_TOKEN=$GITHUB_TOKEN \
          ghcr.io/renovatebot/renovate:37 \
          --dry-run --platform=local

  patch:all:
    cmds:
      - task: patch
        vars:
          PLAYBOOK: generic
      - task: patch
        vars:
          PLAYBOOK: ha
      - task: patch
        vars:
          PLAYBOOK: pihole
      - task: patch
        vars:
          PLAYBOOK: k8s
