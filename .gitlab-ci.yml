stages:
  - stage
  - deploy

image: henrywhitaker3/ansible-terraform

###########
# Ansible #
###########
.playbooks:
  variables:
    ANSIBLE_CONFIG: ./ansible.cfg
  parallel:
    matrix:
      - PLAYBOOK: [docker, vpn, k8s, haproxy, speakers, pihole]
  rules:
    - if: $CI_COMMIT_BRANCH == "main" && $ANSIBLE_RUN_ALL == "true"
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - $PLAYBOOK/*
        - $PLAYBOOK/**/*
        - roles/**/*

ansible lint:
  stage: stage
  extends: .playbooks
  script:
    - task drone-vault-pass VAULT_PASS="$VAULT_PASS"
    - task lint PLAYBOOK=$PLAYBOOK/main.yaml

ansible play:
  stage: deploy
  extends: .playbooks
  script:
    - eval $(ssh-agent -s)
    - task drone-playbook PLAYBOOK=$PLAYBOOK/main.yaml VAULT_PASS="$VAULT_PASS" SSH_KEY="$SSH_KEY"
  environment:
    name: "$PLAYBOOK"


#############
# Terraform #
#############
.terraform:base:
  image: registry.gitlab.com/gitlab-org/terraform-images/stable:latest
  before_script:
    - cd terraform
    - |
      terraform init \
          -backend-config="address=https://gitlab.com/api/v4/projects/45412263/terraform/state/tf-state" \
          -backend-config="lock_address=https://gitlab.com/api/v4/projects/45412263/terraform/state/tf-state/lock" \
          -backend-config="unlock_address=https://gitlab.com/api/v4/projects/45412263/terraform/state/tf-state/lock" \
          -backend-config="username=henrywhitaker3" \
          -backend-config="password=$TERRAFORM_ACCESS_TOKEN" \
          -backend-config="lock_method=POST" \
          -backend-config="unlock_method=DELETE" \
          -backend-config="retry_wait_min=5"
  rules:
    - if: $CI_COMMIT_BRANCH == "main" && $SKIP_TERRAFORM != "true"
      changes:
        - terraform/*
    - if: $SKIP_TERRAFORM == "true"
      when: never

tf plan:
  stage: stage
  extends:
    - .terraform:base
  script:
    - terraform plan -out planfile
  artifacts:
    paths:
      - terraform/planfile

tf deploy:
  stage: deploy
  extends:
    - .terraform:base
  script:
    - terraform apply -auto-approve planfile
  dependencies:
    - tf plan
  environment:
    name: infra
  when: manual

##########
# Docker #
##########
build docker image:
  stage: deploy
  image:
    name: gcr.io/kaniko-project/executor:v1.9.2-debug
    entrypoint: [""]
  script:
    - echo $DOCKER_TOKEN | base64 -d > /kaniko/.docker/config.json
    - /kaniko/executor
      --context "${CI_PROJECT_DIR}"
      --dockerfile "${CI_PROJECT_DIR}/Dockerfile"
      --destination "henrywhitaker3/ansible-terraform:latest"
  rules:
    - if: ($BUILD_DOCKER_IMAGES == "true") && $CI_COMMIT_BRANCH == "main"
    - if: $SKIP_DOCKER_IMAGES == "true"
      when: never
