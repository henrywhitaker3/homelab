stages:
  - lint
  - deploy

image: henrywhitaker3/ansible-terraform

.playbooks:
  parallel:
    matrix:
      - PLAYBOOK: [docker/main.yaml, vpn/main.yaml, k8s/main.yaml, haproxy/main.yaml, speakers/main.yaml, proxmox/main.yaml, pihole/main.yaml]

ansible lint:
  stage: lint
  extends: .playbooks
  script:
    - task drone-vault-pass VAULT_PASS="$VAULT_PASS"
    - task lint PLAYBOOK=k8s/main.yaml

ansible play:
  stage: deploy
  extends: .playbooks
  script:
    - eval $(ssh-agent -s)
    - task drone-playbook PLAYBOOK=docker/main.yaml TARGET_IPS="10.0.0.160" VAULT_PASS="$VAULT_PASS" SSH_KEY="$SSH_KEY"
