---
- name: Get list of active proxy configs
  tags:
    - docker
    - nginx
  command: "echo {{ item | basename }}"
  register: nginx_proxy_confs
  with_fileglob: templates/proxy_confs/*.conf
  delegate_to: localhost
  changed_when: false

- name: Flatten list of configs
  tags:
    - docker
    - nginx
  set_fact:
    nginx_proxy_confs_list: "{{ nginx_proxy_confs.results | map(attribute='stdout') | list | flatten }}"

- name: Set nginx proxy confs dir
  tags:
    - docker
    - nginx
  set_fact:
    nginx_proxy_confs: "{{ docker_data_dir }}/swag/nginx/proxy-confs"

- name: Ensure nginx data dir exists
  tags:
    - docker
    - nginx
  file:
    path: "{{ nginx_proxy_confs }}"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: 0775

- name: Copy nginx proxy-confs
  tags:
    - docker
    - nginx
  template:
    src: "templates/proxy_confs/{{ item }}"
    dest: "{{ nginx_proxy_confs }}/{{ item }}"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: 0664
  loop: "{{ nginx_proxy_confs_list }}"
  notify: restart nginx

- name: Create dns config directory
  tags:
    - docker
    - nginx
  file:
    path: "{{ swag_dns_config }}"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: 0775

- name: Copy cloudflare api creds
  tags:
    - docker
    - nginx
    - cloudflare
  copy:
    content: "{{ cloudflare_creds }}"
    dest: "{{ swag_dns_config }}/cloudflare.ini"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: 0664
