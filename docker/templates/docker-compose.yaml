version: '3.4'
services:
    wireguard:
        container_name: wireguard
        image: linuxserver/wireguard
        cap_add:
          - NET_ADMIN
          - SYS_MODULE
        environment:
            - PUID={{ docker_puid }}
            - PGID={{ docker_pgid }}
            - TZ={{ docker_tz }}
            - SERVERURL=plexmox.com
            - SERVERPORT=51820
            - PEERS={{ wireguard_peers }}
            - PEERDNS=auto
        volumes:
            - {{ docker_data_dir }}/wireguard:/config
            - /lib/modules:/lib/modules
        ports:
            - 51820:51820/udp
        sysctls:
            - net.ipv4.conf.all.src_valid_mark=1
        restart: unless-stopped
        logging:
            driver: "json-file"
            options:
                max-file: "10"
                max-size: "200k"

    swag:
        container_name: swag
        restart: unless-stopped
        image: linuxserver/swag:latest
        ports:
            - 443:443
            - 80:80
        volumes:
            - {{ docker_data_dir }}/swag:/config
            - {{ docker_data_dir }}/organizr:/organizr:ro
        environment:
            - PUID={{ docker_puid }}
            - PGID={{ docker_puid }}
            - TZ={{ docker_tz }}
            - URL=plexmox.com
            - SUBDOMAINS=wildcard
            - VALIDATION=dns
            - DNSPLUGIN=cloudflare
            - ONLY_SUBDOMAINS=false
            - MAXMINDDB_LICENSE_KEY={{ maxmind_license_key }}
        cap_add: [ 'NET_ADMIN' ]
        networks:
            homelab:
        logging:
            driver: "json-file"
            options:
                max-file: "10"
                max-size: "200k"

    organizr:
        container_name: organizr
        restart: unless-stopped
        image: organizr/organizr:latest
        volumes:
            - {{ docker_data_dir }}/organizr:/config
        environment:
            - fpm=true
            - branch=dev
            - TZ={{ docker_tz }}
            - PUID={{ docker_puid }}
            - PGID={{ docker_pgid }}
        networks:
            homelab:
        logging:
            driver: "json-file"
            options:
                max-file: "10"
                max-size: "200k"

    radarr:
        container_name: radarr
        restart: unless-stopped
        image: linuxserver/radarr:nightly
        volumes:
            - {{ docker_data_dir }}/radarr/v3:/config
            - /plex/temp:/downloads
            - /plex/Media/Movies:/movies
        environment:
            - PUID={{ docker_puid }}
            - PGID={{ docker_puid }}
            - TZ={{ docker_tz }}
        networks:
            homelab:
        logging:
            driver: "json-file"
            options:
                max-file: "10"
                max-size: "200k"

    sonarr:
        container_name: sonarr
        restart: unless-stopped
        image: linuxserver/sonarr:latest
        volumes:
            - {{ docker_data_dir }}/sonarr:/config
            - /plex/temp:/downloads
            - "/plex/Media/TV Shows:/tv"
        environment:
            - PUID={{ docker_puid }}
            - PGID={{ docker_puid }}
            - TZ={{ docker_tz }}
        networks:
            homelab:
        logging:
            driver: "json-file"
            options:
                max-file: "10"
                max-size: "200k"

    prowlarr:
        container_name: prowlarr
        restart: unless-stopped
        image: linuxserver/prowlarr:develop
        volumes:
            - {{ docker_data_dir }}/prowlarr:/config
        environment:
            - PUID={{ docker_puid }}
            - PGID={{ docker_puid }}
            - TZ={{ docker_tz }}
        networks:
            homelab:
        logging:
            driver: "json-file"
            options:
                max-file: "10"
                max-size: "200k"

    monitorr:
        container_name: monitorr
        restart: unless-stopped
        image: monitorr/monitorr:latest
        volumes:
            - {{ docker_data_dir }}/monitorr:/app
        environment:
            - TZ={{ docker_tz }}
        networks:
            homelab:
        logging:
            driver: "json-file"
            options:
                max-file: "10"
                max-size: "200k"

    qbittorrent:
        container_name: qbittorrent
        restart: unless-stopped
        image: markusmcnugen/qbittorrentvpn:latest
        privileged: true
        volumes:
            - {{ docker_data_dir }}/torrent/config:/config
            - /plex/temp:/downloads
        environment:
            - NAME_SERVERS=8.8.8.8,8.8.4.4
            - LAN_NETWORK=10.0.0.0/24
            - VPN_ENABLED=yes
        cap_add:
            - NET_ADMIN
        healthcheck:
                test: "${DOCKER_HEALTHCHECK_TEST:-curl --fail -s --max-time 15 https://google.com > /dev/null || bash -c 'kill -s 15 -1 && (sleep 10; kill -s 9 -1)'}"
                interval: "60s"
                timeout: "15s"
                start_period: "30s"
                retries: 0
        networks:
            homelab:

    overseerr:
        container_name: overseerr
        restart: unless-stopped
        image: sctx/overseerr
        environment:
            - TZ={{ docker_tz }}
        volumes:
            - {{ docker_data_dir }}/overseerr:/app/config
        networks:
            homelab:
        logging:
            driver: "json-file"
            options:
                max-file: "10"
                max-size: "200k"

    tautulli:
        container_name: tautulli
        restart: unless-stopped
        image: linuxserver/tautulli:latest
        volumes:
            - {{ docker_data_dir }}/tautulli:/config
        environment:
            - PUID={{ docker_puid }}
            - PGID={{ docker_puid }}
            - TZ={{ docker_tz }}
        networks:
            homelab:
        logging:
            driver: "json-file"
            options:
                max-file: "10"
                max-size: "200k"

    speedtest:
        container_name: speedtest
        restart: unless-stopped
        image: henrywhitaker3/speedtest-tracker:dev
        ports:
            - 8765:80
        volumes:
            - {{ docker_data_dir }}/speedtest:/config
        environment:
            - PUID={{ docker_puid }}
            - PGID={{ docker_puid }}
            - TZ={{ docker_tz }}
            - BASE_PATH=/speedtest
            - OOKLA_EULA_GDPR=true
        networks:
            homelab:
        logging:
            driver: "json-file"
            options:
                max-file: "10"
                max-size: "200k"

    mariadb:
        container_name: mariadb
        restart: unless-stopped
        image: mariadb
        ports:
            - 3306:3306
        volumes:
            - {{ docker_data_dir }}/mariadb:/var/lib/mysql
        environment:
            - MYSQL_ALLOW_EMPTY_PASSWORD=yes
        networks:
            homelab:
        logging:
            driver: "json-file"
            options:
                max-file: "10"
                max-size: "200k"

    plex:
      container_name: plex
      image: linuxserver/plex:latest
      network_mode: host
      environment:
        - PUID={{ docker_puid }}
        - PGID={{ docker_puid }}
        - TZ={{ docker_tz }}
        - VERSION=latest
      devices:
        - /dev/dri:/dev/dri
      volumes:
        - {{ docker_data_dir}}/plex:/config
        - plex:/plex
      restart: unless-stopped

volumes:
    plex:
        driver: local
        driver_opts:
            type: none
            o: bind
            device: /plex
    plex_temp:
        driver: local
        driver_opts:
            type: none
            o: bind
            device: /plex/temp
    plex_tv:
        driver: local
        driver_opts:
            type: none
            o: bind
            device: "/plex/Media/TV Shows"
    plex_movies:
        driver: local
        driver_opts:
            type: none
            o: bind
            device: "/plex/Media/Movies"
    plex_music:
        driver: local
        driver_opts:
            type: none
            o: bind
            device: "/plex/Media/Music"
    plex_audiobooks:
        driver: local
        driver_opts:
            type: none
            o: bind
            device: "/plex/Media/Audiobooks"

networks:
    homelab:
