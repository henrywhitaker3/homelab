---
- name: Configure k8s nodes

  hosts: k8s_nodes

  roles:
    - docker

  handlers:
    - name: reboot node
      become: true
      tags:
        - nodes
        - networking
      ansible.builtin.reboot:

  tasks:
    - name: Set sysctl for pod networking
      become: true
      tags:
        - nodes
        - networking
      ansible.posix.sysctl:
        name: "{{ item }}"
        value: "1"
        reload: true
      loop:
        - net.ipv4.ip_forward

    - name: Add ipset
      become: true
      tags:
        - nodes
        - networking
      ansible.builtin.apt:
        name: ipset
        state: latest
      notify: reboot node
