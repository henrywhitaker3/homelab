projects:
  - name: cluster
    description: Things that make the cluster work
  - name: apps
    description: Our apps running in the cluster

charts:
  - name: metallb
    project: cluster
    namespace: metallb
    chart: metallb
    repoUrl: https://metallb.github.io/metallb
    targetRevision: 0.13.7
    syncPolicy:
      syncOptions:
        - CreateNamespace=true
      automated:
        prune: true
        selfHeal: true

  - name: ingress-nginx
    project: cluster
    namespace: ingress-nginx
    chart: ingress-nginx
    repoUrl: https://kubernetes.github.io/ingress-nginx
    targetRevision: 4.4.2
    values:
      controller:
        watchIngressWithoutClass: true
        replicaCount: 3
        config:
          proxy-real-ip-cidr: "173.245.48.0/20,103.21.244.0/22,103.22.200.0/22,103.31.4.0/22,141.101.64.0/18,108.162.192.0/18,190.93.240.0/20,188.114.96.0/20,197.234.240.0/22,198.41.128.0/17,162.158.0.0/15,104.16.0.0/12,172.64.0.0/13,131.0.72.0/22,2400:cb00::/32,2606:4700::/32,2803:f800::/32,2405:b500::/32,2405:8100::/32,2a06:98c0::/29,2c0f:f248::/32,10.0.0.0/8"
          server-snippet: |
            real_ip_header CF-Connecting-IP;
          use-proxy-protocol: true
    syncPolicy:
      syncOptions:
        - CreateNamespace=true
      automated:
        prune: true
        selfHeal: true

  - name: cert-manager
    project: cluster
    namespace: cert-manager
    chart: cert-manager
    repoUrl: https://charts.jetstack.io
    targetRevision: 1.9.1
    values:
      installCRDs: true
    syncPolicy:
      syncOptions:
        - CreateNamespace=true
      automated:
        prune: true
        selfHeal: true

  - name: sealed-secrets-controller
    project: cluster
    namespace: kube-system
    chart: sealed-secrets
    repoUrl: https://bitnami-labs.github.io/sealed-secrets
    targetRevision: 2.6.9
    values:
      image:
        registry: docker.io
        repository: bitnami/sealed-secrets-controller
    syncPolicy:
      syncOptions:
        - CreateNamespace=true
      automated:
        prune: true
        selfHeal: true

  - name: longhorn
    project: cluster
    namespace: longhorn
    chart: longhorn
    repoUrl: https://charts.longhorn.io
    targetRevision: 1.4.0
    syncPolicy:
      syncOptions:
        - CreateNamespace=true
      automated:
        prune: true
        selfHeal: true

  - name: drone
    project: apps
    namespace: drone
    chart: drone
    repoUrl: https://charts.drone.io
    targetRevision: 0.6.4
    values:
      ingress:
        enabled: true
        annotations:
          kubernetes.io/tls-acme: "true"
          cert-manager.io/cluster-issuer: letsencrypt-prod
        hosts:
          - host: drone.plexmox.com
            paths:
              - path: /
                pathType: Prefix
        tls:
          - secretName: drone-plexmox-com-tls
            hosts:
              - drone.plexmox.com

      extraSecretNamesForEnvFrom:
        - drone-secrets

      env:
        DRONE_SERVER_HOST: drone.plexmox.com
    syncPolicy:
      syncOptions:
        - CreateNamespace=true
      automated:
        prune: true
        selfHeal: true

  - name: drone-runner
    project: apps
    namespace: drone
    chart: drone-runner-docker
    repoUrl: https://charts.drone.io
    targetRevision: 0.6.1
    values:
      replicaCount: 2
      env:
        DRONE_RPC_HOST: drone.plexmox.com
        DRONE_RPC_PROTO: https
      extraSecretNamesForEnvFrom:
        - drone-secrets
      dind:
        extraVolumeMounts: []
    syncPolicy:
      syncOptions:
        - CreateNamespace=true
      automated:
        prune: true
        selfHeal: true

  - name: consul
    project: apps
    namespace: consul
    chart: consul
    repoUrl: https://helm.releases.hashicorp.com
    targetRevision: 1.0.4
    values:
      ui:
        ingress:
          enabled: true
          annotations:
            kubernetes.io/tls-acme: "true"
            # cert-manager.io/cluster-issuer: letsencrypt-prod
          hosts:
            - host: consul.plexmox.com
              paths:
                - /
          tls:
            - hosts:
              - consul.plexmox.com
              secretName: consul-plexmox-com-tls
    syncPolicy:
      syncOptions:
        - CreateNamespace=true
      automated:
        prune: true
        selfHeal: true

  # - name: rancher
  #   project: cluster
  #   namespace: cattle-system
  #   chart: rancher
  #   repoUrl: https://releases.rancher.com/server-charts/stable
  #   targetRevision: 2.7.0
  #   values:
  #     hostname: rancher.plexmox.com
  #     ingress:
  #       tls:
  #         source: letsEncrypt
  #     letsEncrypt:
  #       email: no-reply@plexmox.com
  #   syncPolicy:
  #     syncOptions:
  #       - CreateNamespace=true
  #     automated:
  #       prune: true
  #       selfHeal: true
