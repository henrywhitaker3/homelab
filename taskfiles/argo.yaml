version: "3"

tasks:
  bootstrap:
    cmds:
      - ./scripts/bootstrap_secrets.sh

  install:
    deps: [repo]
    cmds:
      - helm dependency build argo/argocd
      - helm upgrade --install --wait -n argo -f argo/argocd/values.yaml argo argo/argocd/

  repo:
    cmds:
      - helm repo add argo https://argoproj.github.io/argo-helm

  root:
    cmds:
      - kubectl apply -f argo/root

  values:
    cmds:
      - helm -n argo get values argo

  patch:pvc:
      cmds:
        - |
          kubectl patch -n {{ .NAMESPACE }} pvc {{ .NAME }} --patch '{ "metadata": { "annotations": { "meta.helm.sh/release-namespace": "{{ .NAMESPACE }}", "meta.helm.sh/release-name": "{{ .NAME }}" }, "labels": { "app.kubernetes.io/managed-by": "Helm" } } }'

  apps:
    cmds:
      - kubectl -n argo get applications

  go:
    cmds:
      - task: bootstrap
      - task: install
      - task: root
